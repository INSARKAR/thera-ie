# Llama Drug Indication Extraction - File Structure

This document explains the structure and purpose of each file in the Llama drug indication extraction system.

## Project Structure

```
thera/
├── existing_pipeline/
│   ├── pubmed_drug_indications.jl         # Original pipeline (not modified)
│   ├── approved_drugs_extractor.jl        # Original drug extraction
│   └── ...                                # Other existing files
│
├── phase1_drug_pubmed_refs/                      # Input directory (created by original pipeline)
│   ├── Acetophenazine.json               # Individual drug publication data
│   ├── Clopidogrel.json                  # (hundreds of drug files)
│   └── ...
│
├── llama_extracted_indications/           # Output directory (created automatically)
│   ├── Acetophenazine_llama_extracted.json
│   ├── Clopidogrel_llama_extracted.json
│   ├── extraction_summary.json           # Overall analysis summary
│   └── ...
│
└── llama_extraction_system/              # New Llama system files
    ├── llama_drug_indication_extractor.jl  # Main extraction program
    ├── setup_and_run.jl                   # Interactive setup and runner
    ├── validate_setup.jl                  # System validation script
    ├── llama_config.jl                    # Configuration file
    └── README_llama_extraction.md         # Detailed documentation
```

## File Descriptions

### Core System Files

#### `llama_drug_indication_extractor.jl`
**Purpose**: Main extraction engine
**Key Functions**:
- Processes JSON drug files from `phase1_drug_pubmed_refs/`
- Creates prompts for Llama 3.2 from publication data
- Queries Ollama API for indication extraction
- Parses responses and structures results
- Saves individual drug analysis files
- Generates summary reports

**Usage**:
```bash
julia llama_drug_indication_extractor.jl
```

#### `setup_and_run.jl`
**Purpose**: Interactive menu system for easy operation
**Features**:
- Dependency checking and installation
- Ollama connectivity verification
- Multiple execution modes (full, test, single drug)
- Result viewing and management
- Output directory cleanup

**Usage**:
```bash
julia setup_and_run.jl
```

#### `validate_setup.jl`
**Purpose**: System validation and testing
**Tests**:
- Ollama API connectivity
- Llama 3.2 model availability
- File system permissions
- Sample extraction functionality

**Usage**:
```bash
julia validate_setup.jl
```

#### `llama_config.jl`
**Purpose**: Centralized configuration
**Settings**:
- API endpoints and model parameters
- Directory paths
- Processing timeouts and delays
- Confidence thresholds
- Batch processing options

### Input Data Structure

#### `phase1_drug_pubmed_refs/*.json`
**Source**: Generated by original `pubmed_drug_indications.jl` pipeline
**Structure**:
```json
{
  "metadata": {
    "drug_name": "DrugName",
    "filename": "DrugName.json",
    "generated_on": "timestamp",
    "description": "Individual drug analysis result..."
  },
  "result": {
    "drug_name": "DrugName",
    "drugbank_indication": "Official indication from DrugBank",
    "count": 25,
    "publications_analyzed": [
      {
        "pmid": "12345678",
        "title": "Publication title",
        "abstract": "Publication abstract text...",
        "mesh_descriptors": [
          {
            "descriptor": "Disease Name",
            "qualifiers": ["therapy", "diagnosis"]
          }
        ]
      }
    ],
    "disease_analysis": { ... },
    "pmids": [ ... ]
  }
}
```

### Output Data Structure

#### `llama_extracted_indications/*_llama_extracted.json`
**Purpose**: Individual drug analysis results from Llama extraction
**Structure**:
```json
{
  "metadata": {
    "drug_name": "DrugName",
    "analysis_time": "2024-01-01T12:00:00",
    "processing_duration_seconds": 45.2,
    "model_used": "llama3.2",
    "total_publications": 25,
    "successful_extractions": 23,
    "failed_extractions": 2,
    "total_indications_extracted": 8
  },
  "extracted_indications": [
    {
      "indication": "Specific disease or condition",
      "confidence": 0.95,
      "pmid": "12345678",
      "title": "Source publication title",
      "source_text": "Title: ... Abstract: ...",
      "extracted_at": "2024-01-01T12:00:00"
    }
  ]
}
```

#### `llama_extracted_indications/extraction_summary.json`
**Purpose**: Comprehensive analysis summary
**Structure**:
```json
{
  "analysis_summary": {
    "total_drugs_analyzed": 150,
    "total_publications_processed": 3750,
    "total_indications_extracted": 892,
    "average_indications_per_drug": 5.95,
    "total_processing_time_seconds": 1843.2,
    "analysis_completed_at": "2024-01-01T12:00:00",
    "model_used": "llama3.2"
  },
  "drug_results": [
    {
      "drug_name": "DrugName",
      "publications_count": 25,
      "indications_extracted": 6,
      "processing_time_seconds": 12.3
    }
  ],
  "top_indications": [
    {"indication": "Depression", "frequency": 45},
    {"indication": "Anxiety", "frequency": 38},
    {"indication": "Schizophrenia", "frequency": 32}
  ]
}
```

## Workflow

### 1. Data Preparation
- Original pipeline (`pubmed_drug_indications.jl`) processes PubMed data
- Creates individual drug JSON files in `phase1_drug_pubmed_refs/`
- Each file contains publications and MeSH term analysis

### 2. Llama Analysis Setup
- Install Ollama and Llama 3.2 model
- Run validation script to ensure everything works
- Configure settings in `llama_config.jl` if needed

### 3. Extraction Process
- Main extractor reads drug JSON files
- For each publication in each drug file:
  - Creates prompt with title, abstract, MeSH terms
  - Queries Llama 3.2 for indication extraction
  - Parses response for indication-confidence pairs
- Saves results incrementally

### 4. Results Analysis
- Individual drug files show specific extractions
- Summary file provides overview statistics
- Top indications show most common therapeutic uses
- Processing metadata enables performance analysis

## Integration Points

### With Existing Pipeline
- **Input**: Uses JSON files from `pubmed_drug_indications.jl`
- **Standalone**: Doesn't modify existing code or data
- **Complementary**: Provides alternative indication extraction method

### Comparison Opportunities
- DrugBank official indications (in input files)
- MeSH-based disease associations (in input files)
- Llama-extracted indications (new output)
- Manual validation and quality assessment

## Execution Modes

### Full Analysis
```bash
julia llama_drug_indication_extractor.jl
```
- Processes all drug files
- Complete extraction analysis
- Full summary report

### Test Mode
```bash
LLAMA_TEST_MODE=true LLAMA_MAX_FILES=5 julia llama_drug_indication_extractor.jl
```
- Processes first 5 files only
- Quick validation of system
- Subset analysis for testing

### Single Drug Analysis
```bash
LLAMA_SINGLE_DRUG="Acetophenazine" julia llama_drug_indication_extractor.jl
```
- Processes one specific drug
- Detailed analysis of individual cases
- Debugging and validation

### Interactive Mode
```bash
julia setup_and_run.jl
```
- Menu-driven interface
- Dependency checking
- Multiple execution options
- Result management

## Dependencies and Requirements

### Software Dependencies
- Julia 1.6+
- Ollama with Llama 3.2 model
- Julia packages: HTTP, JSON3, Dates, Logging

### System Requirements
- Network access for Ollama API
- ~500MB disk space for model
- Write permissions to output directory
- Sufficient memory for JSON processing

### Performance Characteristics
- ~1-2 minutes per drug (depends on publication count)
- ~30-50 API calls per drug on average
- Linear scaling with number of publications
- Rate-limited to respect API constraints
